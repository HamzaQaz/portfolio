# TanStack Start Migration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Migrate the NightlyDev portfolio from Vite + React Router DOM to TanStack Start with SSR, file-based routing, and lazy-hydrated animations.

**Architecture:** Replace the current Vite SPA with TanStack Start's full-stack framework. Convert 2 React Router routes to file-based routes. Wrap WebGL/canvas animation components with a ClientOnly boundary for SSR compatibility. All 29 existing components remain unchanged except for `Link` import swaps.

**Tech Stack:** TanStack Start, TanStack Router, Vite, React 19, TypeScript, Tailwind CSS 4, Framer Motion, GSAP, OGL

---

### Task 1: Install dependencies

**Files:**
- Modify: `package.json`

**Step 1: Install TanStack Start and Router packages**

Run:
```bash
cd /c/dev/portfolio && npm install @tanstack/react-router @tanstack/react-start
```

**Step 2: Install dev dependencies**

Run:
```bash
cd /c/dev/portfolio && npm install -D vite-tsconfig-paths @tanstack/react-router-devtools
```

**Step 3: Remove react-router-dom**

Run:
```bash
cd /c/dev/portfolio && npm uninstall react-router-dom
```

**Step 4: Commit**

```bash
cd /c/dev/portfolio && git add package.json package-lock.json && git commit -m "chore: swap react-router-dom for tanstack start/router"
```

---

### Task 2: Update Vite and TypeScript config

**Files:**
- Modify: `vite.config.ts`
- Modify: `tsconfig.json`
- Modify: `tsconfig.app.json`

**Step 1: Replace vite.config.ts**

Replace the entire file with:

```typescript
import { defineConfig } from 'vite'
import { tanstackStart } from '@tanstack/react-start/plugin/vite'
import viteReact from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import tsconfigPaths from 'vite-tsconfig-paths'

export default defineConfig({
  plugins: [
    tailwindcss(),
    tsconfigPaths(),
    tanstackStart(),
    viteReact(),
  ],
})
```

Changes: removed manual `path.resolve` alias (replaced by `vite-tsconfig-paths`), added `tanstackStart()` plugin.

**Step 2: Update tsconfig.app.json**

Remove `"types": ["vite/client"]` and remove `"verbatimModuleSyntax": true` (TanStack Start's codegen uses non-verbatim re-exports). Keep everything else.

The updated `compilerOptions` should be:

```json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"]
}
```

**Step 3: Commit**

```bash
cd /c/dev/portfolio && git add vite.config.ts tsconfig.json tsconfig.app.json && git commit -m "chore: configure vite and tsconfig for tanstack start"
```

---

### Task 3: Create ClientOnly helper component

**Files:**
- Create: `src/components/ClientOnly.tsx`

**Step 1: Create the ClientOnly component**

This component renders nothing on the server and hydrates its children on the client. It's needed for WebGL (Aurora, SplashCursor), canvas (LetterGlitch), and interval-based (FaultyTerminal) components that can't run during SSR.

```tsx
import { useState, useEffect, type ReactNode } from 'react'

export default function ClientOnly({ children, fallback = null }: { children: ReactNode; fallback?: ReactNode }) {
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    setMounted(true)
  }, [])

  return mounted ? <>{children}</> : <>{fallback}</>
}
```

**Step 2: Commit**

```bash
cd /c/dev/portfolio && git add src/components/ClientOnly.tsx && git commit -m "feat: add ClientOnly helper for SSR-safe rendering"
```

---

### Task 4: Create router config and root layout

**Files:**
- Create: `src/router.tsx`
- Create: `src/routes/__root.tsx`

**Step 1: Create src/router.tsx**

```tsx
import { createRouter } from '@tanstack/react-router'
import { routeTree } from './routeTree.gen'

export function getRouter() {
  const router = createRouter({
    routeTree,
    scrollRestoration: true,
  })

  return router
}

declare module '@tanstack/react-router' {
  interface Register {
    router: ReturnType<typeof getRouter>
  }
}
```

Note: `routeTree.gen` won't exist yet — it gets auto-generated by TanStack Router's CLI when the dev server starts.

**Step 2: Create src/routes/__root.tsx**

This replaces both `index.html` and the layout wrapper from `main.tsx`. It sets up the HTML shell, fonts, global CSS, the Noise overlay, and the page transition wrapper.

```tsx
import {
  HeadContent,
  Outlet,
  Scripts,
  createRootRoute,
} from '@tanstack/react-router'
import appCss from '@/index.css?url'
import Noise from '@/components/Noise'

export const Route = createRootRoute({
  head: () => ({
    meta: [
      { charSet: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1.0' },
      { title: 'NightlyDev — Full-Stack Developer' },
    ],
    links: [
      { rel: 'icon', type: 'image/svg+xml', href: '/favicon.svg' },
      { rel: 'stylesheet', href: appCss },
      { rel: 'preconnect', href: 'https://cdn.fontshare.com', crossOrigin: 'anonymous' },
      {
        rel: 'preload',
        href: 'https://cdn.fontshare.com/wf/TLLFHOEQ6HZNXIRGXNTZUSDWI54K3ZOG/GCTHXIDYQODDAWD6XSRPNXFRJ3GWYWDB/EB5XKUIIJJKWYJCOFYLJ3MXWCETTVBIR.woff2',
        as: 'font',
        type: 'font/woff2',
        crossOrigin: 'anonymous',
      },
      {
        rel: 'preload',
        href: 'https://cdn.fontshare.com/wf/TLLFHOEQ6HZNXIRGXNTZUSDWI54K3ZOG/GUY5XQIBLV72BJBTRMO6F5LXPZQX5RNO/MVDQMRXV6WNKTBBNFKMG2JVKBLXNXRRV.woff2',
        as: 'font',
        type: 'font/woff2',
        crossOrigin: 'anonymous',
      },
    ],
  }),
  component: RootComponent,
})

function RootComponent() {
  return (
    <html lang="en">
      <head>
        <HeadContent />
      </head>
      <body>
        <div className="min-h-screen bg-background text-foreground relative">
          <Noise />
          <Outlet />
        </div>
        <Scripts />
      </body>
    </html>
  )
}
```

**Step 3: Commit**

```bash
cd /c/dev/portfolio && git add src/router.tsx src/routes/__root.tsx && git commit -m "feat: add tanstack router config and root layout"
```

---

### Task 5: Create route files (index + people)

**Files:**
- Create: `src/routes/index.tsx`
- Create: `src/routes/people.tsx`

**Step 1: Create src/routes/index.tsx**

This replaces the content from `App.tsx`. The Aurora component is wrapped in `ClientOnly` since it uses WebGL.

```tsx
import { createFileRoute } from '@tanstack/react-router'
import { Nav } from '@/components/sections/Nav'
import { Hero } from '@/components/sections/Hero'
import { About } from '@/components/sections/About'
import { Skills } from '@/components/sections/Skills'
import { Projects } from '@/components/sections/Projects'
import { Contact } from '@/components/sections/Contact'
import Aurora from '@/components/Aurora'
import ScrollVelocity from '@/components/ScrollVelocity'
import ClientOnly from '@/components/ClientOnly'
import { motion, useScroll, useTransform } from 'motion/react'

export const Route = createFileRoute('/')({
  component: HomePage,
})

function HomePage() {
  const { scrollYProgress } = useScroll()
  const auroraOpacity = useTransform(scrollYProgress, [0.05, 0.2], [0, 0.15])

  return (
    <>
      <ClientOnly>
        <motion.div className="fixed inset-0 z-0" style={{ opacity: auroraOpacity }}>
          <Aurora colorStops={['#059669', '#34d399', '#064e3b']} speed={0.5} />
        </motion.div>
      </ClientOnly>

      <div className="relative z-10">
        <Nav />
        <Hero />

        <div className="border-y border-neutral-800/30 py-4">
          <ScrollVelocity
            texts={[
              'React — TypeScript — Node.js — Python — AWS — Docker — PostgreSQL — Next.js — Tailwind — GraphQL — Redis — Linux —',
              'Infrastructure — DevOps — CI/CD — Figma — Prisma — REST APIs — GitHub Actions — Vercel — MongoDB — Bash —',
            ]}
            velocity={30}
            className="text-neutral-700 font-medium font-display"
            scrollerClassName="!text-lg !md:text-xl !leading-normal"
          />
        </div>

        <About />
        <Skills />
        <Projects />
        <Contact />
      </div>
    </>
  )
}
```

**Step 2: Create src/routes/people.tsx**

This wraps the content from `pages/People.tsx`. The `Link` import changes from `react-router-dom` to `@tanstack/react-router`.

```tsx
import { createFileRoute } from '@tanstack/react-router'
import { Link } from '@tanstack/react-router'
import { motion } from 'motion/react'
import { useRef, type MouseEvent } from 'react'
import { ArrowLeft, Heart } from 'lucide-react'
import GradientText from '@/components/GradientText'

export const Route = createFileRoute('/people')({
  component: PeoplePage,
})

// ─── Customize your people here ───────────────────────────────────────────────
const people: Person[] = [
  {
    name: 'H4lf',
    description: 'The OG, the one who gave me the opertunity to show what I can do and the one who hosts this website. Absolute legend.',
    colors: ['#3b82f6', '#34d399'],
  },
  {
    name: 'stellarsqilin',
    description: 'Chill, Funny, and really easy to jumpscare',
    colors: ['#7dd3fc', '#f0f9ff'],
  },
  {
    name: 'akason1cc',
    description: 'Very Chill, love his roomate in his mic background, and is a great friend to have around.',
    colors: ['#ef4444', '#22d3ee'],
  },
  {
    name: 'potatoleo',
    description: 'Chill Valorant player, and is always down to play some games. he a potato but a good one.',
    colors: ['#a16207', '#451a03'],
  },
  {
    name: 'SakuraBob',
    description: 'He just a bob',
    colors: ['#f472b6', '#a855f7'],
  },
]

interface Person {
  name: string
  description: string
  colors?: [string, string]
}

function PersonCard({ person, index }: { person: Person; index: number }) {
  const cardRef = useRef<HTMLDivElement>(null)
  const [c1, c2] = person.colors ?? ['#34d399', '#3b82f6']

  const handleMouseMove = (e: MouseEvent<HTMLDivElement>) => {
    const card = cardRef.current
    if (!card) return
    const rect = card.getBoundingClientRect()
    const x = e.clientX - rect.left
    const y = e.clientY - rect.top
    const centerX = rect.width / 2
    const centerY = rect.height / 2
    const rotateX = ((y - centerY) / centerY) * -6
    const rotateY = ((x - centerX) / centerX) * 6
    card.style.transform = `perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`
    card.style.setProperty('--shine-x', `${(x / rect.width) * 100}%`)
    card.style.setProperty('--shine-y', `${(y / rect.height) * 100}%`)
  }

  const handleMouseLeave = () => {
    const card = cardRef.current
    if (!card) return
    card.style.transform = 'perspective(800px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)'
  }

  const hexToRgba = (hex: string, a: number) => {
    const r = parseInt(hex.slice(1, 3), 16)
    const g = parseInt(hex.slice(3, 5), 16)
    const b = parseInt(hex.slice(5, 7), 16)
    return `rgba(${r},${g},${b},${a})`
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 24 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.45, delay: index * 0.1, ease: 'easeOut' }}
    >
      <div
        ref={cardRef}
        onMouseMove={handleMouseMove}
        onMouseLeave={handleMouseLeave}
        className="group relative rounded-2xl p-[1px] transition-all duration-300 ease-out cursor-default"
        style={{
          background: `linear-gradient(135deg, ${hexToRgba(c1, 0.2)}, ${hexToRgba(c2, 0.2)})`,
          transformStyle: 'preserve-3d',
        }}
      >
        <div
          className="absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"
          style={{
            background: `linear-gradient(135deg, ${c1}, ${c2}, ${c1})`,
            filter: 'blur(1px)',
          }}
        />
        <div
          className="absolute -inset-1.5 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 -z-10"
          style={{
            background: `linear-gradient(135deg, ${hexToRgba(c1, 0.25)}, ${hexToRgba(c2, 0.25)})`,
            filter: 'blur(20px)',
          }}
        />
        <div className="relative rounded-2xl bg-neutral-950 p-5 sm:p-6 overflow-hidden">
          <div
            className="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
            style={{
              background: 'radial-gradient(circle at var(--shine-x, 50%) var(--shine-y, 50%), rgba(255,255,255,0.07) 0%, transparent 60%)',
            }}
          />
          <div
            className="absolute top-0 left-6 right-6 h-[1px] opacity-40 group-hover:opacity-80 transition-opacity duration-500"
            style={{ background: `linear-gradient(90deg, transparent, ${c1}, ${c2}, transparent)` }}
          />
          <div className="flex items-start gap-3 sm:gap-4 mt-2">
            <div
              className="w-11 h-11 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center shrink-0 border transition-shadow duration-300 group-hover:shadow-lg"
              style={{
                background: `linear-gradient(135deg, ${hexToRgba(c1, 0.15)}, ${hexToRgba(c2, 0.15)})`,
                borderColor: hexToRgba(c1, 0.2),
                boxShadow: '0 0 0 0 transparent',
              }}
              onMouseEnter={(e) => {
                ;(e.currentTarget as HTMLDivElement).style.boxShadow = `0 0 16px ${hexToRgba(c1, 0.3)}`
              }}
              onMouseLeave={(e) => {
                ;(e.currentTarget as HTMLDivElement).style.boxShadow = '0 0 0 0 transparent'
              }}
            >
              <span className="text-base sm:text-lg font-bold font-display" style={{ color: c1 }}>
                {person.name.charAt(0).toUpperCase()}
              </span>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="font-display font-bold text-white text-base sm:text-lg mb-1">{person.name}</h3>
              <p className="text-neutral-400 text-xs sm:text-sm leading-relaxed">{person.description}</p>
            </div>
            <Heart
              className="w-4 h-4 shrink-0 mt-1 transition-all duration-300 group-hover:scale-110"
              style={{ color: hexToRgba(c1, 0.3) }}
              onMouseEnter={(e) => { ;(e.currentTarget as SVGSVGElement).style.color = c1 }}
              onMouseLeave={(e) => { ;(e.currentTarget as SVGSVGElement).style.color = hexToRgba(c1, 0.3) }}
            />
          </div>
        </div>
      </div>
    </motion.div>
  )
}

function PeoplePage() {
  return (
    <div className="relative z-10 px-6 sm:px-8 md:px-16 lg:px-24 py-10 sm:py-16">
      <div className="max-w-4xl mx-auto">
        <motion.div
          initial={{ opacity: 0, x: -10 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.3 }}
        >
          <Link
            to="/"
            className="inline-flex items-center gap-2 text-neutral-500 hover:text-emerald-400 transition-colors text-sm mb-8 sm:mb-12"
          >
            <ArrowLeft className="w-4 h-4" />
            Back home
          </Link>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="mb-10 sm:mb-16"
        >
          <p className="text-xs uppercase tracking-[0.3em] text-emerald-400/60 font-medium mb-3">
            My People
          </p>
          <h1 className="font-display text-3xl sm:text-4xl md:text-6xl font-bold tracking-tight mb-4">
            Favourite{' '}
            <GradientText
              colors={['#34d399', '#6ee7b7', '#3b82f6', '#34d399']}
              animationSpeed={4}
              className="inline"
            >
              People
            </GradientText>
          </h1>
          <div className="h-1 w-16 bg-emerald-400 rounded-full mt-4 mb-4" />
          <p className="text-neutral-400 text-base sm:text-lg max-w-lg">
            The people who made the biggest impact on me. Wouldn't be where I am without them.
          </p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
          {people.map((person, i) => (
            <PersonCard key={person.name} person={person} index={i} />
          ))}
        </div>
      </div>
    </div>
  )
}
```

**Step 3: Commit**

```bash
cd /c/dev/portfolio && git add src/routes/index.tsx src/routes/people.tsx && git commit -m "feat: add tanstack file-based route components"
```

---

### Task 6: Update Link imports in shared components

**Files:**
- Modify: `src/components/sections/Nav.tsx`
- Modify: `src/components/ui/resizable-navbar.tsx`

These are the only 2 remaining files that import `Link` from `react-router-dom`. Change the import source to `@tanstack/react-router`.

**Step 1: Update Nav.tsx**

Change line 2 from:
```tsx
import { Link } from "react-router-dom";
```
To:
```tsx
import { Link } from "@tanstack/react-router";
```

Everything else in Nav.tsx stays identical. TanStack Router's `Link` uses `to` prop just like React Router.

**Step 2: Update resizable-navbar.tsx**

Change line 12 from:
```tsx
import { Link } from "react-router-dom";
```
To:
```tsx
import { Link } from "@tanstack/react-router";
```

Everything else stays identical.

**Step 3: Commit**

```bash
cd /c/dev/portfolio && git add src/components/sections/Nav.tsx src/components/ui/resizable-navbar.tsx && git commit -m "refactor: swap react-router-dom Link imports to tanstack router"
```

---

### Task 7: Delete old files

**Files:**
- Delete: `src/main.tsx`
- Delete: `src/App.tsx`
- Delete: `src/pages/People.tsx`
- Delete: `index.html`

**Step 1: Remove the old entry point and route files**

These files have been replaced by:
- `main.tsx` → TanStack Start handles entry automatically
- `App.tsx` → `src/routes/index.tsx`
- `pages/People.tsx` → `src/routes/people.tsx`
- `index.html` → `src/routes/__root.tsx` (head/body managed by TanStack Start)

Run:
```bash
cd /c/dev/portfolio && rm src/main.tsx src/App.tsx src/pages/People.tsx index.html && rmdir src/pages 2>/dev/null; true
```

**Step 2: Commit**

```bash
cd /c/dev/portfolio && git add -A && git commit -m "chore: remove old react-router entry files replaced by tanstack start"
```

---

### Task 8: Update package.json scripts

**Files:**
- Modify: `package.json`

**Step 1: Update scripts**

The build script should no longer run `tsc -b` separately — TanStack Start handles TypeScript compilation via Vite. Update the scripts:

Change:
```json
"scripts": {
  "dev": "vite",
  "build": "tsc -b && vite build",
  "lint": "eslint .",
  "preview": "vite preview"
}
```

To:
```json
"scripts": {
  "dev": "vite",
  "build": "vite build",
  "lint": "eslint .",
  "preview": "vite preview"
}
```

**Step 2: Commit**

```bash
cd /c/dev/portfolio && git add package.json && git commit -m "chore: simplify build script for tanstack start"
```

---

### Task 9: Boot dev server and verify

**Step 1: Start the dev server**

Run:
```bash
cd /c/dev/portfolio && npm run dev
```

This should:
1. Auto-generate `src/routeTree.gen.ts`
2. Start the Vite dev server with TanStack Start's SSR
3. Serve the portfolio at `http://localhost:5173` (or whatever port Vite picks)

**Step 2: Verify both routes**

- Visit `http://localhost:<port>/` — should show the full portfolio with Nav, Hero, ScrollVelocity, About, Skills, Projects, Contact, and the Aurora background
- Visit `http://localhost:<port>/people` — should show the People page with animated cards
- Click "People" in the nav → should navigate to /people
- Click "Back home" on the people page → should navigate to /

**Step 3: Verify SSR**

- View page source (Ctrl+U) on the index page — should see rendered HTML content (headings, text, links), not just an empty `<div id="root">`
- Aurora/SplashCursor should NOT appear in the HTML source (they're client-only)

**Step 4: Fix any issues**

Common issues to watch for:
- `routeTree.gen.ts` not generated → restart dev server
- TypeScript errors about `verbatimModuleSyntax` → verify it was removed from tsconfig.app.json
- OGL/GSAP SSR errors → ensure those components are wrapped in ClientOnly
- Missing CSS → verify the `?url` import suffix on `appCss` in `__root.tsx`

**Step 5: Commit the generated route tree**

```bash
cd /c/dev/portfolio && git add src/routeTree.gen.ts && git commit -m "chore: add generated route tree"
```

---

### Task 10: Wrap remaining client-only components (if needed)

After booting the dev server, check for SSR hydration errors in the browser console. If any animation components besides Aurora cause SSR errors, wrap them with ClientOnly in their parent route files.

Likely candidates that may need wrapping:
- `SplashCursor` (if used — it's 1,288 lines of WebGL)
- `LetterGlitch` (canvas-based)
- `FaultyTerminal` (interval-based DOM manipulation)

For each problematic component, wrap it:
```tsx
<ClientOnly>
  <ProblematicComponent />
</ClientOnly>
```

**Step 1: Check browser console for SSR hydration errors**

Open browser dev tools → Console tab. Look for errors like:
- "document is not defined"
- "window is not defined"
- "Hydration failed"

**Step 2: Wrap any failing components**

Add `ClientOnly` wrapper around any components that reference `window`, `document`, `canvas`, or WebGL APIs.

**Step 3: Commit fixes**

```bash
cd /c/dev/portfolio && git add -A && git commit -m "fix: wrap client-only animation components for SSR"
```
